<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fluxo de Caixa com Firebase</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        /* Estilos mantidos iguais */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            overflow-x: hidden;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            margin-top: 20px;
            max-height: 80vh;
        }
        table {
            border-collapse: collapse;
            min-width: 1400px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 120px;
        }
        th {
            background-color: #f2f2f2;
        }
        th:first-child {
            position: sticky;
            left: 0;
            top: 0;
            z-index: 4;
            background: #f2f2f2;
            min-width: 200px;
        }
        th.mes-header {
            position: sticky;
            top: 0;
            z-index: 3;
            background: #f2f2f2;
        }
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;
            background: white;
            min-width: 200px;
        }
        .saldo {
            background-color: #e6ffe6;
        }
        input {
            width: 100px;
            text-align: right;
            padding: 4px;
        }
        .category-input, .period-controls {
            margin: 10px 0;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            padding: 10px 0;
        }
        #chartContainer {
            margin-top: 40px;
            max-width: 800px;
        }
        .category-actions {
            display: inline-block;
            margin-left: 10px;
        }
        .drag-handle {
            cursor: move;
            color: #666;
            margin: 0 5px;
            display: none;
        }
        .edit-input {
            width: 120px;
            padding: 2px;
        }
        .toggle-actions {
            cursor: pointer;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-left: 10px;
        }
        .show-actions .drag-handle,
        .show-actions .category-actions button {
            display: inline-block;
        }
        .category-actions button {
            display: none;
            margin-left: 5px;
            cursor: pointer;
            background: none;
            border: none;
        }
        .period-controls button {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Controle de Fluxo de Caixa em Tempo Real</h1>
    
    <div class="period-controls">
        <button onclick="changePeriod(-1)">◄ Mês Anterior</button>
        <span id="currentPeriod"></span>
        <button onclick="changePeriod(1)">Próximo Mês ►</button>
    </div>

    <div class="category-input">
        <input type="text" id="newCategory" placeholder="Nova categoria">
        <button onclick="addCategory()">Adicionar Categoria</button>
        <span class="toggle-actions" onclick="toggleActions()">▼ Mostrar Controles</span>
    </div>

    <div class="table-container">
        <table id="fluxoTable">
            <tr>
                <th>Categoria/Mês</th>
            </tr>
            <tr id="salarioRow">
                <td>Salário</td>
            </tr>
            <tr id="gastosHeader">
                <td>Gastos</td>
            </tr>
            <tr id="saldoRow">
                <td class="saldo">Saldo</td>
            </tr>
        </table>
    </div>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        // Configuração do Firebase (Substitua com suas credenciais)
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            databaseURL: "https://SEU_PROJETO.firebaseio.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let myChart = null;
        const meses = [];
        let currentDate = new Date();
        let categories = [];
        let draggedRow = null;
        let showActions = false;
        let userId = null;

        function generateMonths() {
            meses.length = 0;
            const startDate = new Date(currentDate);
            startDate.setMonth(startDate.getMonth() - 12);

            for (let i = 0; i < 36; i++) {
                const date = new Date(startDate);
                date.setMonth(date.getMonth() + i);
                const mesKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                meses.push({
                    key: mesKey,
                    date: date,
                    name: date.toLocaleString('pt-BR', { month: 'long' }),
                    year: date.getFullYear()
                });
            }
            
            const start = meses[0].date;
            const end = meses[meses.length-1].date;
            document.getElementById('currentPeriod').textContent = 
                `Exibindo: ${start.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})} - ${end.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}`;
        }

        function changePeriod(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            initTable();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        async function initTable() {
            userId = localStorage.getItem('userId') || generateUserId();
            localStorage.setItem('userId', userId);
            
            await loadUserData();
            generateMonths();
            buildTableStructure();
            await loadCategories();
            await loadMonthData();
            setupRealTimeUpdates();
            calculate();
            updateActionsVisibility();
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        async function loadUserData() {
            try {
                const snapshot = await database.ref(`users/${userId}`).once('value');
                const data = snapshot.val() || {};
                
                categories = data.categories || [];
                showActions = data.settings?.showActions || false;
                currentDate = new Date(data.settings?.currentDate || new Date());
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        function buildTableStructure() {
            const headerRow = document.querySelector('#fluxoTable tr:first-child');
            const salarioRow = document.querySelector('#salarioRow');
            const saldoRow = document.querySelector('#saldoRow');

            headerRow.innerHTML = '<th>Categoria/Mês</th>';
            salarioRow.innerHTML = '<td>Salário</td>';
            saldoRow.innerHTML = '<td class="saldo">Saldo</td>';

            meses.forEach(mes => {
                headerRow.innerHTML += `<th class="mes-header">${mes.name}/${mes.year}</th>`;
                salarioRow.innerHTML += `<td><input type="number" id="salario_${mes.key}" data-mes="${mes.key}" step="100"></td>`;
                saldoRow.innerHTML += `<td class="saldo" id="saldo_${mes.key}">${formatCurrency(0)}</td>`;
            });
        }

        async function loadCategories() {
            const categoriesRef = database.ref(`users/${userId}/categories`);
            categoriesRef.on('value', (snapshot) => {
                categories = snapshot.val() || [];
                rebuildCategoryRows();
            });
        }

        function rebuildCategoryRows() {
            const existingRows = document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)');
            existingRows.forEach(row => row.remove());
            
            categories.forEach(cat => createCategoryRow(cat));
        }

        function createCategoryRow(categoryName) {
            const newRow = document.createElement('tr');
            newRow.draggable = showActions;
            newRow.classList.toggle('show-actions', showActions);
            newRow.innerHTML = `
                <td>
                    <span class="category-name">${categoryName}</span>
                    <div class="category-actions">
                        <span class="drag-handle">↕</span>
                        <button class="edit-btn">✏️</button>
                        <button class="delete-btn">❌</button>
                    </div>
                </td>
            `;

            meses.forEach(mes => {
                newRow.innerHTML += `
                    <td>
                        <input type="number" 
                               id="${categoryName}_${mes.key}"
                               data-mes="${mes.key}"
                               step="100">
                    </td>`;
            });

            document.querySelector('#gastosHeader').insertAdjacentElement('afterend', newRow);
            addRowListeners(newRow);
            setupInputListeners(newRow);
        }

        async function loadMonthData() {
            const monthsRef = database.ref(`users/${userId}/months`);
            monthsRef.on('value', (snapshot) => {
                const monthsData = snapshot.val() || {};
                Object.entries(monthsData).forEach(([monthKey, monthData]) => {
                    // Carrega salário
                    const salaryInput = document.getElementById(`salario_${monthKey}`);
                    if (salaryInput) salaryInput.value = monthData.salario || 0;
                    
                    // Carrega categorias
                    categories.forEach(cat => {
                        const input = document.getElementById(`${cat}_${monthKey}`);
                        if (input) input.value = monthData[cat] || 0;
                    });
                });
                calculate();
            });
        }

        function setupInputListeners(row) {
            row.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', async function() {
                    const [category, monthKey] = this.id.split('_');
                    await database.ref(`users/${userId}/months/${monthKey}/${category}`).set(Number(this.value));
                    calculate();
                });
            });
        }

        async function addCategory() {
            const categoryName = document.getElementById('newCategory').value.trim();
            if (!categoryName || categories.includes(categoryName)) return;

            const newCategories = [...categories, categoryName];
            await database.ref(`users/${userId}/categories`).set(newCategories);
            document.getElementById('newCategory').value = '';
        }

        async function deleteCategory(button) {
            const row = button.closest('tr');
            const categoryName = row.querySelector('.category-name').textContent;
            
            if (!confirm(`Tem certeza que deseja excluir a categoria "${categoryName}"?`)) return;

            const newCategories = categories.filter(cat => cat !== categoryName);
            await database.ref(`users/${userId}/categories`).set(newCategories);
            
            // Remove dados dos meses
            const updates = {};
            meses.forEach(mes => {
                updates[`/users/${userId}/months/${mes.key}/${categoryName}`] = null;
            });
            await database.ref().update(updates);
        }

        async function editCategory(button) {
            const row = button.closest('tr');
            const nameCell = row.querySelector('.category-name');
            const currentName = nameCell.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'edit-input';
            
            input.onblur = async function() {
                const newName = this.value.trim();
                if (newName && newName !== currentName) {
                    await updateCategoryName(currentName, newName);
                }
                nameCell.textContent = newName || currentName;
                input.replaceWith(nameCell);
            };
            
            nameCell.replaceWith(input);
            input.focus();
        }

        async function updateCategoryName(oldName, newName) {
            // Atualiza categorias
            const newCategories = categories.map(cat => cat === oldName ? newName : cat);
            await database.ref(`users/${userId}/categories`).set(newCategories);
            
            // Atualiza dados dos meses
            const updates = {};
            const snapshot = await database.ref(`users/${userId}/months`).once('value');
            const monthsData = snapshot.val() || {};
            
            Object.keys(monthsData).forEach(monthKey => {
                if (monthsData[monthKey][oldName]) {
                    updates[`/users/${userId}/months/${monthKey}/${newName}`] = monthsData[monthKey][oldName];
                    updates[`/users/${userId}/months/${monthKey}/${oldName}`] = null;
                }
            });
            
            await database.ref().update(updates);
        }

        function setupRealTimeUpdates() {
            database.ref(`users/${userId}`).on('value', () => {
                calculate();
            });
        }

        async function calculate() {
            try {
                const snapshot = await database.ref(`users/${userId}/months`).once('value');
                const monthsData = snapshot.val() || {};
                
                let saldoAnterior = 0;
                const saldos = [];

                meses.forEach(mes => {
                    const mesData = monthsData[mes.key] || {};
                    const salario = Number(mesData.salario) || 0;
                    let totalGastos = 0;

                    categories.forEach(cat => {
                        totalGastos += Number(mesData[cat]) || 0;
                    });

                    const saldoAtual = saldoAnterior + salario - totalGastos;
                    document.getElementById(`saldo_${mes.key}`).textContent = formatCurrency(saldoAtual);
                    saldos.push(saldoAtual);
                    saldoAnterior = saldoAtual;
                });

                updateChart(saldos);
            } catch (error) {
                console.error('Erro ao calcular:', error);
            }
        }

        function updateChart(saldos) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const currentMonthIndex = meses.findIndex(m => m.date >= new Date());
            const chartData = saldos.slice(currentMonthIndex, currentMonthIndex + 12);
            const chartLabels = meses.slice(currentMonthIndex, currentMonthIndex + 12)
                .map(m => `${m.name}/${m.year}`);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Projeção do Saldo (12 meses)',
                        data: chartData,
                        borderColor: '#4CAF50',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function toggleActions() {
            showActions = !showActions;
            updateActionsVisibility();
            document.querySelector('.toggle-actions').textContent = 
                `${showActions ? '▲ Ocultar' : '▼ Mostrar'} Controles`;
            saveSettings();
        }

        function updateActionsVisibility() {
            const rows = document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)');
            rows.forEach(row => {
                row.classList.toggle('show-actions', showActions);
                row.draggable = showActions;
            });
        }

        function addRowListeners(row) {
            // Eventos de edição e exclusão
            row.querySelector('.edit-btn').addEventListener('click', (e) => editCategory(e.target));
            row.querySelector('.delete-btn').addEventListener('click', (e) => deleteCategory(e.target));

            // Drag and drop
            row.addEventListener('dragstart', () => draggedRow = row);
            row.addEventListener('dragover', e => e.preventDefault());
            row.addEventListener('drop', async e => {
                e.preventDefault();
                if (draggedRow && draggedRow !== row) {
                    const rows = Array.from(document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)'));
                    const oldIndex = rows.indexOf(draggedRow);
                    const newIndex = rows.indexOf(row);
                    
                    if (oldIndex < newIndex) {
                        row.insertAdjacentElement('afterend', draggedRow);
                    } else {
                        row.insertAdjacentElement('beforebegin', draggedRow);
                    }
                    
                    const newOrder = Array.from(rows).map(r => r.querySelector('.category-name').textContent);
                    await database.ref(`users/${userId}/categories`).set(newOrder);
                }
            });
        }

        async function saveSettings() {
            await database.ref(`users/${userId}/settings`).update({
                showActions,
                currentDate: currentDate.toISOString()
            });
        }

        // Inicialização
        initTable();
    </script>
</body>
</html>
