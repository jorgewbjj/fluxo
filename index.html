<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fluxo de Caixa Histórico</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            overflow-x: hidden;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            margin-top: 20px;
            max-height: 80vh;
        }
        table {
            border-collapse: collapse;
            min-width: 1400px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 120px;
        }
        th {
            background-color: #f2f2f2;
        }
        th:first-child {
            position: sticky;
            left: 0;
            top: 0;
            z-index: 4;
            background: #f2f2f2;
            min-width: 200px;
        }
        th.mes-header {
            position: sticky;
            top: 0;
            z-index: 3;
            background: #f2f2f2;
        }
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 1;
            background: white;
            min-width: 200px;
        }
        .saldo {
            background-color: #e6ffe6;
        }
        input {
            width: 100px;
            text-align: right;
            padding: 4px;
        }
        .category-input, .period-controls {
            margin: 10px 0;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            padding: 10px 0;
        }
        #chartContainer {
            margin-top: 40px;
            max-width: 800px;
        }
        .category-actions {
            display: inline-block;
            margin-left: 10px;
        }
        .drag-handle {
            cursor: move;
            color: #666;
            margin: 0 5px;
            display: none;
        }
        .edit-input {
            width: 120px;
            padding: 2px;
        }
        .toggle-actions {
            cursor: pointer;
            padding: 5px 10px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-left: 10px;
        }
        .show-actions .drag-handle,
        .show-actions .category-actions button {
            display: inline-block;
        }
        .category-actions button {
            display: none;
            margin-left: 5px;
            cursor: pointer;
            background: none;
            border: none;
        }
        .period-controls button {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Controle de Fluxo de Caixa - Histórico Completo</h1>
    
    <div class="period-controls">
        <button onclick="changePeriod(-1)">◄ Mês Anterior</button>
        <span id="currentPeriod"></span>
        <button onclick="changePeriod(1)">Próximo Mês ►</button>
    </div>

    <div class="category-input">
        <input type="text" id="newCategory" placeholder="Nova categoria">
        <button onclick="addCategory()">Adicionar Categoria</button>
        <span class="toggle-actions" onclick="toggleActions()">▼ Mostrar Controles</span>
    </div>

    <div class="table-container">
        <table id="fluxoTable">
            <tr>
                <th>Categoria/Mês</th>
            </tr>
            <tr id="salarioRow">
                <td>Salário</td>
            </tr>
            <tr id="gastosHeader">
                <td>Gastos</td>
            </tr>
            <tr id="saldoRow">
                <td class="saldo">Saldo</td>
            </tr>
        </table>
    </div>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        let myChart = null;
        const meses = [];
        let currentDate = new Date(localStorage.getItem('currentDate') || new Date());
        let categories = JSON.parse(localStorage.getItem('categories')) || [];
        let draggedRow = null;
        let showActions = localStorage.getItem('showActions') === 'true';

        function generateMonths() {
            meses.length = 0;
            const startDate = new Date(currentDate);
            startDate.setMonth(startDate.getMonth() - 12);

            for (let i = 0; i < 36; i++) {
                const date = new Date(startDate);
                date.setMonth(date.getMonth() + i);
                const mesKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                meses.push({
                    key: mesKey,
                    date: date,
                    name: date.toLocaleString('pt-BR', { month: 'long' }),
                    year: date.getFullYear()
                });
            }
            
            const start = meses[0].date;
            const end = meses[meses.length-1].date;
            document.getElementById('currentPeriod').textContent = 
                `Exibindo: ${start.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})} - ${end.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}`;
        }

        function changePeriod(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            localStorage.setItem('currentDate', currentDate);
            initTable();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function initTable() {
            generateMonths();
            const headerRow = document.querySelector('#fluxoTable tr:first-child');
            const salarioRow = document.querySelector('#salarioRow');
            const saldoRow = document.querySelector('#saldoRow');

            headerRow.innerHTML = '<th>Categoria/Mês</th>';
            salarioRow.innerHTML = '<td>Salário</td>';
            saldoRow.innerHTML = '<td class="saldo">Saldo</td>';

            meses.forEach(mes => {
                headerRow.innerHTML += `<th class="mes-header">${mes.name}/${mes.year}</th>`;
                
                salarioRow.innerHTML += `
                    <td>
                        <input type="number" 
                               id="salario_${mes.key}" 
                               data-mes="${mes.key}"
                               step="100"
                               value="0">
                    </td>`;

                saldoRow.innerHTML += `<td class="saldo" id="saldo_${mes.key}">${formatCurrency(0)}</td>`;
            });

            loadSavedData();
            addAutoSaveListeners();
            loadCategories();
            calculate();
            updateActionsVisibility();
            document.querySelector('.toggle-actions').textContent = 
                `${showActions ? '▲ Ocultar' : '▼ Mostrar'} Controles`;
        }

        function addCategory() {
            const categoryName = document.getElementById('newCategory').value.trim();
            if (!categoryName || categories.includes(categoryName)) return;

            categories.push(categoryName);
            saveCategories();
            createCategoryRow(categoryName);
            document.getElementById('newCategory').value = '';
        }

        function createCategoryRow(categoryName) {
            const newRow = document.createElement('tr');
            newRow.draggable = showActions;
            newRow.classList.toggle('show-actions', showActions);
            newRow.innerHTML = `
                <td>
                    <span class="category-name">${categoryName}</span>
                    <div class="category-actions">
                        <span class="drag-handle">↕</span>
                        <button onclick="editCategory(this)">✏️</button>
                        <button onclick="deleteCategory(this)">❌</button>
                    </div>
                </td>
            `;

            meses.forEach(mes => {
                newRow.innerHTML += `
                    <td>
                        <input type="number" 
                               id="${categoryName}_${mes.key}"
                               data-mes="${mes.key}"
                               step="100"
                               value="0">
                    </td>`;
            });

            document.querySelector('#gastosHeader').insertAdjacentElement('afterend', newRow);
            
            addRowListeners(newRow);
            loadSavedDataForRow(newRow);
            addAutoSaveListenersForRow(newRow);
            calculate();
        }

        function toggleActions() {
            showActions = !showActions;
            localStorage.setItem('showActions', showActions);
            updateActionsVisibility();
            document.querySelector('.toggle-actions').textContent = 
                `${showActions ? '▲ Ocultar' : '▼ Mostrar'} Controles`;
        }

        function updateActionsVisibility() {
            const rows = document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)');
            rows.forEach(row => {
                row.classList.toggle('show-actions', showActions);
                row.draggable = showActions;
            });
        }

        function editCategory(button) {
            const row = button.closest('tr');
            const nameCell = row.querySelector('.category-name');
            const currentName = nameCell.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'edit-input';
            
            input.onblur = function() {
                const newName = this.value.trim();
                if (newName && newName !== currentName) {
                    updateCategoryName(currentName, newName);
                }
                nameCell.textContent = newName || currentName;
                input.replaceWith(nameCell);
            };
            
            nameCell.replaceWith(input);
            input.focus();
        }

        function updateCategoryName(oldName, newName) {
            meses.forEach(mes => {
                const oldKey = `${oldName}_${mes.key}`;
                const newKey = `${newName}_${mes.key}`;
                const value = localStorage.getItem(oldKey);
                
                if (value !== null) {
                    localStorage.setItem(newKey, value);
                    localStorage.removeItem(oldKey);
                }
            });

            document.querySelectorAll(`input[id^="${oldName}_"]`).forEach(input => {
                input.id = input.id.replace(oldName, newName);
            });

            const index = categories.indexOf(oldName);
            if (index > -1) {
                categories[index] = newName;
                saveCategories();
            }
        }

        function deleteCategory(button) {
            const row = button.closest('tr');
            const categoryName = row.querySelector('.category-name').textContent;
            
            if (!confirm(`Tem certeza que deseja excluir a categoria "${categoryName}"?`)) return;

            meses.forEach(mes => {
                localStorage.removeItem(`${categoryName}_${mes.key}`);
            });

            categories = categories.filter(cat => cat !== categoryName);
            saveCategories();

            row.remove();
            calculate();
        }

        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        function loadCategories() {
            categories.forEach(cat => createCategoryRow(cat));
        }

        function addRowListeners(row) {
            row.addEventListener('dragstart', () => draggedRow = row);
            row.addEventListener('dragover', e => e.preventDefault());
            row.addEventListener('drop', e => {
                e.preventDefault();
                if (draggedRow && draggedRow !== row) {
                    const rows = Array.from(document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)'));
                    const oldIndex = rows.indexOf(draggedRow);
                    const newIndex = rows.indexOf(row);
                    
                    if (oldIndex < newIndex) {
                        row.insertAdjacentElement('afterend', draggedRow);
                    } else {
                        row.insertAdjacentElement('beforebegin', draggedRow);
                    }
                    
                    updateCategoriesOrder();
                }
            });
        }

        function updateCategoriesOrder() {
            categories = Array.from(document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)'))
                .map(row => row.querySelector('.category-name').textContent);
            saveCategories();
        }

        function loadSavedData() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                const savedValue = localStorage.getItem(input.id);
                if (savedValue !== null) {
                    input.value = savedValue;
                }
            });
        }

        function loadSavedDataForRow(row) {
            row.querySelectorAll('input').forEach(input => {
                const savedValue = localStorage.getItem(input.id);
                if (savedValue !== null) {
                    input.value = savedValue;
                }
            });
        }

        function addAutoSaveListeners() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', function() {
                    localStorage.setItem(this.id, this.value);
                    calculate();
                });
            });
        }

        function addAutoSaveListenersForRow(row) {
            row.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', function() {
                    localStorage.setItem(this.id, this.value);
                    calculate();
                });
            });
        }

        function calculate() {
            let saldoAnterior = 0;
            const saldos = [];

            meses.forEach(mes => {
                let totalGastos = 0;
                document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)').forEach(row => {
                    const input = row.querySelector(`input[data-mes="${mes.key}"]`);
                    if (input) totalGastos += Number(input.value);
                });

                const salario = Number(document.getElementById(`salario_${mes.key}`).value);
                const saldoAtual = saldoAnterior + salario - totalGastos;
                
                document.getElementById(`saldo_${mes.key}`).textContent = formatCurrency(saldoAtual);
                saldos.push(saldoAtual);
                saldoAnterior = saldoAtual;
            });

            updateChart(saldos);
        }

        function updateChart(saldos) {
            const ctx = document.getElementById('myChart').getContext('2d');
            const currentMonthIndex = meses.findIndex(m => m.date >= new Date());
            const chartData = saldos.slice(currentMonthIndex, currentMonthIndex + 12);
            const chartLabels = meses.slice(currentMonthIndex, currentMonthIndex + 12)
                .map(m => `${m.name}/${m.year}`);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Projeção do Saldo (12 meses)',
                        data: chartData,
                        borderColor: '#4CAF50',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function cleanOldData() {
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            
            Object.keys(localStorage).forEach(key => {
                const match = key.match(/(\d{4})-(\d{2})$/);
                if (match) {
                    const year = parseInt(match[1]);
                    const month = parseInt(match[2]) - 1;
                    const keyDate = new Date(year, month);
                    
                    if (keyDate < twoYearsAgo) {
                        localStorage.removeItem(key);
                    }
                }
            });
        }

        // Inicialização
        cleanOldData();
        initTable();
    </script>
</body>
</html>
