      <!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Fluxo de Caixa 24 Meses</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            push, 
            onValue, 
            update, 
            remove,
            get 
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Configura√ß√£o do Firebase (substitua com seus dados)
const firebaseConfig = {
  apiKey: "AIzaSyCgSkYIvenfEzyjef50OD01Ox9et-nyBMo",
  authDomain: "fluxo-6d716.firebaseapp.com",
  databaseURL: "https://fluxo-6d716-default-rtdb.firebaseio.com",
  projectId: "fluxo-6d716",
  storageBucket: "fluxo-6d716.firebasestorage.app",
  messagingSenderId: "761253335013",
  appId: "1:761253335013:web:44c30372a4749203a3690c"
};

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Elementos da UI
        const elements = {
            categoryName: document.getElementById('categoryName'),
            categoryType: document.getElementById('categoryType'),
            categoriesList: document.getElementById('categoriesList'),
            transactionCategory: document.getElementById('transactionCategory'),
            transactionAmount: document.getElementById('transactionAmount'),
            transactionMonth: document.getElementById('transactionMonth'),
            balanceDiv: document.getElementById('balance'),
            loading: document.getElementById('loading')
        };

        // Gerar 24 meses a partir do atual
        function generateMonths() {
            const months = [];
            const today = new Date();
            today.setDate(1); // Garantir que estamos no primeiro dia do m√™s
            for(let i = 0; i < 24; i++) {
                const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                months.push(`${year}-${month}`);
            }
            return months;
        }

        // Carregar categorias
        async function loadCategories() {
            try {
                const snapshot = await get(ref(database, 'categories'));
                const categories = snapshot.val() || {};
                populateCategories(categories);
                populateCategorySelect(categories);
                return categories;
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                throw error;
            }
        }

        function populateCategories(categories) {
            elements.categoriesList.innerHTML = '<h3>Categorias Cadastradas</h3>';
            for (const [key, category] of Object.entries(categories)) {
                elements.categoriesList.innerHTML += `
                    <div class="category-item">
                        <span class="category-name">${category.name}</span>
                        <span class="category-type ${category.type}">(${category.type === 'income' ? 'Receita' : 'Despesa'})</span>
                        <button onclick="editCategory('${key}')">‚úèÔ∏è</button>
                        <button onclick="deleteCategory('${key}')">üóëÔ∏è</button>
                    </div>
                `;
            }
        }

        function populateCategorySelect(categories) {
            elements.transactionCategory.innerHTML = '';
            for (const [key, category] of Object.entries(categories)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${category.name} (${category.type === 'income' ? '+' : '-'})`;
                elements.transactionCategory.appendChild(option);
            }
        }

        // Fun√ß√µes CRUD Categorias
        window.addCategory = async () => {
            try {
                if (!elements.categoryName.value.trim()) {
                    alert('Digite um nome para a categoria');
                    return;
                }

                await push(ref(database, 'categories'), {
                    name: elements.categoryName.value.trim(),
                    type: elements.categoryType.value
                });
                elements.categoryName.value = '';
            } catch (error) {
                console.error('Erro ao adicionar categoria:', error);
                alert('Erro ao criar categoria!');
            }
        };

        window.editCategory = async (key) => {
            const newName = prompt('Novo nome da categoria:');
            if (newName) {
                try {
                    await update(ref(database, `categories/${key}`), { name: newName });
                } catch (error) {
                    console.error('Erro ao editar categoria:', error);
                    alert('Erro ao atualizar categoria!');
                }
            }
        };

        window.deleteCategory = async (key) => {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                try {
                    await remove(ref(database, `categories/${key}`));
                } catch (error) {
                    console.error('Erro ao excluir categoria:', error);
                    alert('Erro ao excluir categoria!');
                }
            }
        };

        // Fun√ß√µes Transa√ß√µes
        window.addTransaction = async () => {
            try {
                const amount = parseFloat(elements.transactionAmount.value);
                const month = elements.transactionMonth.value;
                
                if (!validateTransaction(amount, month)) return;

                await push(ref(database, 'transactions'), {
                    category: elements.transactionCategory.value,
                    amount: amount,
                    month: month,
                    timestamp: Date.now()
                });
                
                elements.transactionAmount.value = '';
            } catch (error) {
                console.error('Erro ao adicionar transa√ß√£o:', error);
                alert('Erro ao registrar transa√ß√£o!');
            }
        };

        function validateTransaction(amount, month) {
            if (isNaN(amount) || amount <= 0) {
                alert('Valor inv√°lido! Deve ser maior que zero');
                return false;
            }
            
            if (!month) {
                alert('Selecione um m√™s v√°lido!');
                return false;
            }
            
            if (!elements.transactionCategory.value) {
                alert('Selecione uma categoria!');
                return false;
            }
            
            return true;
        }

        // Processamento de Dados
        async function processFinancialData() {
            try {
                const [transactionsSnapshot, categoriesSnapshot] = await Promise.all([
                    get(ref(database, 'transactions')),
                    get(ref(database, 'categories'))
                ]);
                
                const transactions = transactionsSnapshot.val() || {};
                const categories = categoriesSnapshot.val() || {};
                const months = generateMonths();

                const balanceData = initializeBalanceData(categories, months);
                populateBalanceData(balanceData, transactions, categories, months);

                return { balanceData, months };
            } catch (error) {
                console.error('Erro ao processar dados:', error);
                throw error;
            }
        }

        function initializeBalanceData(categories, months) {
            const balanceData = {};
            Object.entries(categories).forEach(([catId, cat]) => {
                balanceData[catId] = {
                    name: cat.name,
                    type: cat.type,
                    months: Object.fromEntries(months.map(m => [m, 0])),
                    total: 0
                };
            });
            return balanceData;
        }

        function populateBalanceData(balanceData, transactions, categories, months) {
            Object.values(transactions).forEach(transaction => {
                const catId = transaction.category;
                if (!balanceData[catId] || !months.includes(transaction.month)) return;

                const amount = categories[catId].type === 'income' 
                    ? transaction.amount 
                    : -transaction.amount;

                balanceData[catId].months[transaction.month] += amount;
                balanceData[catId].total += amount;
            });
        }

        // Renderiza√ß√£o da Tabela
        function renderCashFlowTable(balanceData, months) {
            let html = `
                <div class="table-header">
                    <h3>Proje√ß√£o de Fluxo de Caixa (24 Meses)</h3>
                    <small>Atualizado em: ${new Date().toLocaleDateString()}</small>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sticky-header">Categoria</th>
                                ${months.map(m => `
                                    <th class="month-header">
                                        ${formatMonth(m)}
                                    </th>
                                `).join('')}
                                <th class="sticky-header">Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Linhas das categorias
            Object.values(balanceData).forEach(data => {
                html += `
                    <tr>
                        <td class="category-cell ${data.type}">
                            ${data.name}
                            <span class="type-badge">${data.type === 'income' ? 'Receita' : 'Despesa'}</span>
                        </td>
                        ${months.map(month => `
                            <td class="value-cell ${data.months[month] >= 0 ? 'positive' : 'negative'}">
                                ${formatCurrency(data.months[month])}
                            </td>
                        `).join('')}
                        <td class="total-cell ${data.total >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(data.total)}
                        </td>
                    </tr>
                `;
            });

            // Linha de totais
            html += `
                    <tr class="totals-row">
                        <th class="sticky-header">Total Mensal</th>
                        ${months.map(month => {
                            const total = Object.values(balanceData).reduce((sum, cat) => sum + cat.months[month], 0);
                            return `
                                <td class="total-cell ${total >= 0 ? 'positive' : 'negative'}">
                                    ${formatCurrency(total)}
                                </td>
                            `;
                        }).join('')}
                        <td class="grand-total">
                            ${formatCurrency(Object.values(balanceData).reduce((sum, cat) => sum + cat.total, 0))}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>`;

            elements.balanceDiv.innerHTML = html;
        }

        // Fun√ß√µes auxiliares
        function formatMonth(monthString) {
            const [year, month] = monthString.split('-');
            return `${month}/${year.substring(2)}`;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Inicializa√ß√£o
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                elements.loading.style.display = 'block';
                await loadCategories();
                
                onValue(ref(database, 'transactions'), async () => {
                    const { balanceData, months } = await processFinancialData();
                    renderCashFlowTable(balanceData, months);
                });

                elements.loading.style.display = 'none';
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                elements.loading.style.display = 'none';
                alert('Erro ao carregar dados!');
            }
        });
    </script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --income-color: #27ae60;
            --expense-color: #c0392b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f6fa;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        input, select, button {
            padding: 12px;
            margin: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .table-container {
            overflow-x: auto;
            max-height: 80vh;
        }

        table {
            min-width: 1200px;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .sticky-header {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .month-header {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            min-width: 40px;
            vertical-align: bottom;
            padding: 10px 5px !important;
        }

        .category-cell {
            text-align: left;
            white-space: nowrap;
        }

        .type-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }

        .income .type-badge {
            background: var(--income-color);
            color: white;
        }

        .expense .type-badge {
            background: var(--expense-color);
            color: white;
        }

        .value-cell, .total-cell {
            min-width: 100px;
            font-family: monospace;
        }

        .positive { color: var(--income-color); }
        .negative { color: var(--expense-color); }

        .totals-row {
            background: #f8f9fa;
            font-weight: bold;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            input, select, button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div id="loading">Carregando...</div>
    
    <div class="container">
        <div class="section">
            <h2>üìÅ Gerenciar Categorias</h2>
            <input type="text" id="categoryName" placeholder="Nova categoria">
            <select id="categoryType">
                <option value="income">Receita</option>
                <option value="expense">Despesa</option>
            </select>
            <button onclick="addCategory()">‚ûï Adicionar</button>
            <div id="categoriesList"></div>
        </div>

        <div class="section">
            <h2>üí∏ Nova Transa√ß√£o</h2>
            <select id="transactionCategory"></select>
            <input type="number" id="transactionAmount" placeholder="Valor" step="0.01">
            <input type="month" id="transactionMonth">
            <button onclick="addTransaction()">üíæ Salvar</button>
        </div>

        <div class="section">
            <h2>üìä Fluxo de Caixa (24 Meses)</h2>
            <div id="balance"></div>
        </div>
    </div>
</body>
</html>
