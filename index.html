<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão Financeira Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            overflow-x: hidden;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            margin-top: 20px;
            max-height: 80vh;
        }
        table {
            border-collapse: collapse;
            min-width: 1400px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            min-width: 120px;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        th:first-child {
            left: 0;
            z-index: 4;
            min-width: 200px;
        }
        td:first-child {
            position: sticky;
            left: 0;
            background: white;
            z-index: 1;
        }
        .saldo {
            background-color: #e6ffe6;
        }
        input {
            width: 100px;
            text-align: right;
            padding: 4px;
        }
        .category-input, .period-controls {
            margin: 10px 0;
            position: sticky;
            left: 0;
            background: white;
            z-index: 5;
            padding: 10px 0;
        }
        #chartContainer {
            margin-top: 40px;
            max-width: 800px;
            height: 400px;
        }
        .category-actions {
            display: inline-block;
            margin-left: 10px;
        }
        .drag-handle {
            cursor: move;
            color: #666;
            margin: 0 5px;
            display: none;
        }
        .show-actions .drag-handle,
        .show-actions .category-actions button {
            display: inline-block;
        }
        .category-actions button {
            display: none;
            margin-left: 5px;
            cursor: pointer;
            background: none;
            border: none;
        }
    </style>
</head>
<body>
    <h1>Gestão Financeira - 3 Anos</h1>
    
    <div class="period-controls">
        <button onclick="changePeriod(-1)">◄ Período Anterior</button>
        <span id="currentPeriod"></span>
        <button onclick="changePeriod(1)">Próximo Período ►</button>
    </div>

    <div class="category-input">
        <input type="text" id="newCategory" placeholder="Nova categoria">
        <button onclick="addCategory()">Adicionar Categoria</button>
        <span class="toggle-actions" onclick="toggleActions()">▼ Mostrar Controles</span>
    </div>

    <div class="table-container">
        <table id="fluxoTable">
            <tr>
                <th>Categoria/Mês</th>
            </tr>
            <tr id="salarioRow">
                <td>Salário</td>
            </tr>
            <tr id="gastosHeader">
                <td>Gastos</td>
            </tr>
            <tr id="saldoRow">
                <td class="saldo">Saldo</td>
            </tr>
        </table>
    </div>

    <div id="chartContainer">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        // Configuração do Firebase (SUBSTITUA COM SUAS CREDENCIAIS)
const firebaseConfig = {
  apiKey: "AIzaSyCgSkYIvenfEzyjef50OD01Ox9et-nyBMo",
  authDomain: "fluxo-6d716.firebaseapp.com",
  databaseURL: "https://fluxo-6d716-default-rtdb.firebaseio.com",
  projectId: "fluxo-6d716",
  storageBucket: "fluxo-6d716.firebasestorage.app",
  messagingSenderId: "761253335013",
  appId: "1:761253335013:web:44c30372a4749203a3690c"
};

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let myChart = null;
        const meses = [];
        let currentDate = new Date();
        let categories = [];
        let draggedRow = null;
        let showActions = false;
        let userId = null;

        // 1. Inicialização do Sistema
        async function initTable() {
            userId = localStorage.getItem('userId') || generateUserId();
            localStorage.setItem('userId', userId);
            
            await setupFirebaseListeners();
            generateMonths();
            buildTableStructure();
            updateActionsVisibility();
        }

        // 2. Configuração dos Listeners do Firebase
        async function setupFirebaseListeners() {
            // Listener para Categorias
            database.ref(`users/${userId}/categories`).on('value', snapshot => {
                categories = snapshot.val() || [];
                rebuildCategoryRows();
                calculate();
            });

            // Listener para Configurações
            database.ref(`users/${userId}/settings`).on('value', snapshot => {
                const settings = snapshot.val() || {};
                showActions = settings.showActions || false;
                currentDate = new Date(settings.currentDate || new Date());
                generateMonths();
                buildTableStructure();
                updateActionsVisibility();
            });

            // Listener para Dados Mensais
            database.ref(`users/${userId}/months`).on('value', () => {
                loadMonthData().then(calculate);
            });
        }

        // 3. Geração dos Meses
        function generateMonths() {
            meses.length = 0;
            const baseDate = new Date(currentDate);
            baseDate.setMonth(baseDate.getMonth() - 12); // 12 meses anteriores

            for (let i = 0; i < 36; i++) { // 3 anos de dados
                const date = new Date(baseDate);
                date.setMonth(date.getMonth() + i);
                meses.push({
                    key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                    date: date,
                    name: date.toLocaleString('pt-BR', { month: 'long' }),
                    year: date.getFullYear()
                });
            }
            updatePeriodDisplay();
        }

        // 4. Construção da Tabela
        function buildTableStructure() {
            const headerRow = document.querySelector('#fluxoTable tr:first-child');
            const salarioRow = document.querySelector('#salarioRow');
            const saldoRow = document.querySelector('#saldoRow');

            // Limpar estrutura existente
            headerRow.innerHTML = '<th>Categoria/Mês</th>';
            salarioRow.innerHTML = '<td>Salário</td>';
            saldoRow.innerHTML = '<td class="saldo">Saldo</td>';

            // Adicionar meses
            meses.forEach(mes => {
                headerRow.innerHTML += `<th class="mes-header">${mes.name}/${mes.year}</th>`;
                salarioRow.innerHTML += `<td><input type="number" id="salario_${mes.key}" data-mes="${mes.key}" step="100"></td>`;
                saldoRow.innerHTML += `<td class="saldo" id="saldo_${mes.key}">${formatCurrency(0)}</td>`;
            });
        }

        // 5. Carregamento de Dados
        async function loadMonthData() {
            return new Promise(resolve => {
                database.ref(`users/${userId}/months`).once('value', snapshot => {
                    const monthsData = snapshot.val() || {};
                    meses.forEach(mes => {
                        const mesData = monthsData[mes.key] || {};
                        // Atualizar salários
                        const salaryInput = document.getElementById(`salario_${mes.key}`);
                        if (salaryInput) salaryInput.value = mesData.salario || 0;
                        // Atualizar categorias
                        categories.forEach(cat => {
                            const input = document.getElementById(`${cat}_${mes.key}`);
                            if (input) input.value = mesData[cat] || 0;
                        });
                    });
                    resolve();
                });
            });
        }

        // 6. Cálculos Financeiros
        async function calculate() {
            try {
                const snapshot = await database.ref(`users/${userId}/months`).once('value');
                const monthsData = snapshot.val() || {};
                
                let saldoAnterior = 0;
                const saldos = [];

                meses.forEach(mes => {
                    const mesData = monthsData[mes.key] || {};
                    const salario = Number(mesData.salario) || 0;
                    const gastos = categories.reduce((acc, cat) => acc + Number(mesData[cat] || 0), 0);
                    const saldo = saldoAnterior + salario - gastos;
                    
                    // Atualizar UI
                    document.getElementById(`saldo_${mes.key}`).textContent = formatCurrency(saldo);
                    saldos.push(saldo);
                    saldoAnterior = saldo;
                });

                updateChart(saldos);
            } catch (error) {
                console.error('Erro nos cálculos:', error);
            }
        }

        // 7. Gráfico Interativo
        function updateChart(saldos) {
            const ctx = document.getElementById('myChart').getContext('2d');
            
            // Destruir gráfico anterior
            if (myChart) myChart.destroy();

            // Configurar dados do gráfico
            const currentMonthIndex = meses.findIndex(m => m.date >= new Date());
            const chartData = saldos.slice(currentMonthIndex, currentMonthIndex + 12);
            const chartLabels = meses.slice(currentMonthIndex, currentMonthIndex + 12)
                .map(m => `${m.name}/${m.year}`);

            // Criar novo gráfico
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Projeção de Saldo',
                        data: chartData,
                        borderColor: '#4CAF50',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // 8. Gestão de Categorias
        async function addCategory() {
            const name = document.getElementById('newCategory').value.trim();
            if (!name || categories.includes(name)) return;
            
            await database.ref(`users/${userId}/categories`).set([...categories, name]);
            document.getElementById('newCategory').value = '';
        }

        async function deleteCategory(button) {
            const row = button.closest('tr');
            const name = row.querySelector('.category-name').textContent;
            if (!confirm(`Excluir "${name}" permanentemente?`)) return;
            
            // Atualizar categorias
            const newCategories = categories.filter(cat => cat !== name);
            await database.ref(`users/${userId}/categories`).set(newCategories);
            
            // Remover dados históricos
            const updates = {};
            meses.forEach(mes => {
                updates[`users/${userId}/months/${mes.key}/${name}`] = null;
            });
            await database.ref().update(updates);
        }

        // 9. Funções Auxiliares
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { 
                style: 'currency', 
                currency: 'BRL' 
            }).format(value);
        }

        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        function updatePeriodDisplay() {
            const start = meses[0].date;
            const end = meses[meses.length-1].date;
            document.getElementById('currentPeriod').textContent = 
                `Exibindo: ${start.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})} - ${end.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}`;
        }

        function toggleActions() {
            showActions = !showActions;
            updateActionsVisibility();
            saveSettings();
        }

        function updateActionsVisibility() {
            const rows = document.querySelectorAll('#gastosHeader ~ tr:not(#saldoRow)');
            rows.forEach(row => {
                row.classList.toggle('show-actions', showActions);
                row.draggable = showActions;
            });
            document.querySelector('.toggle-actions').textContent = 
                `${showActions ? '▲ Ocultar' : '▼ Mostrar'} Controles`;
        }

        async function saveSettings() {
            await database.ref(`users/${userId}/settings`).update({
                showActions,
                currentDate: currentDate.toISOString()
            });
        }

        // 10. Inicialização
        initTable();
    </script>
</body>
</html>
