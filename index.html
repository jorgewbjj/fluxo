<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fluxo de Caixa Avançado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6 text-center">Fluxo de Caixa com Firebase</h1>
    <button id="add-category" class="mb-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Adicionar Categoria</button>

    <div class="overflow-auto shadow-lg rounded-lg bg-white mb-6">
      <table class="min-w-full text-sm text-gray-700" id="cashflow-table">
        <thead class="bg-gray-200 text-gray-600 uppercase text-xs">
          <tr id="header-row">
            <th class="py-3 px-4 text-left">Categoria</th>
            <!-- Meses adicionados via JS -->
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
        <tfoot class="bg-gray-100 font-semibold text-sm">
          <tr id="saldo-row">
            <td class="py-2 px-4">Saldo</td>
            <!-- Saldos mensais inseridos via JS -->
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="mb-6">
      <canvas id="cashflowChart"></canvas>
    </div>
  </div>

  <!-- Modal -->
  <div id="category-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg p-6 shadow-lg max-w-sm w-full">
      <h2 class="text-lg font-semibold mb-4">Nova Categoria</h2>
      <label class="block mb-2">Nome:
        <input id="new-category-name" type="text" class="w-full border px-3 py-2 rounded mt-1">
      </label>
      <label class="block mb-4">Tipo:
        <select id="new-category-type" class="w-full border px-3 py-2 rounded mt-1">
          <option value="Receita">Receita</option>
          <option value="Despesa">Despesa</option>
        </select>
      </label>
      <div class="text-right">
        <button id="cancel-modal" class="mr-2 px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancelar</button>
        <button id="save-category" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Salvar</button>
      </div>
    </div>
  </div>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyCgSkYIvenfEzyjef50OD01Ox9et-nyBMo",
  authDomain: "fluxo-6d716.firebaseapp.com",
  databaseURL: "https://fluxo-6d716-default-rtdb.firebaseio.com",
  projectId: "fluxo-6d716",
  storageBucket: "fluxo-6d716.firebasestorage.app",
  messagingSenderId: "761253335013",
  appId: "1:761253335013:web:44c30372a4749203a3690c"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    const months = [];
    let now = new Date();
    for (let i = 0; i < 24; i++) {
      months.push(`${monthNames[now.getMonth()]}/${now.getFullYear().toString().slice(-2)}`);
      now.setMonth(now.getMonth() + 1);
    }

    const headerRow = document.getElementById("header-row");
    const saldoRow = document.getElementById("saldo-row");
    const tableBody = document.getElementById("table-body");
    const addBtn = document.getElementById("add-category");
    const chartCtx = document.getElementById("cashflowChart").getContext("2d");

    const modal = document.getElementById("category-modal");
    const cancelModal = document.getElementById("cancel-modal");
    const saveCategory = document.getElementById("save-category");
    const newCategoryName = document.getElementById("new-category-name");
    const newCategoryType = document.getElementById("new-category-type");

    let chart;

    months.forEach(month => {
      const th = document.createElement("th");
      th.className = "py-3 px-4 text-center";
      th.innerText = month;
      headerRow.appendChild(th);

      const saldoTd = document.createElement("td");
      saldoTd.className = "text-center py-2 px-4";
      saldoTd.setAttribute("data-month", month);
      saldoRow.appendChild(saldoTd);
    });

    function updateSaldoRow(saldos) {
      months.forEach(month => {
        const td = saldoRow.querySelector(`[data-month='${month}']`);
        td.innerText = saldos[month]?.toFixed(2) || "0.00";
      });
    }

    function renderChart(data) {
      const saldos = months.map(month => data.saldos[month] || 0);

      if (chart) chart.destroy();

      chart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Saldo Mensal',
              data: saldos,
              borderColor: 'rgba(59,130,246,1)',
              backgroundColor: 'rgba(59,130,246,0.2)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Saldo Mensal nos Próximos 24 Meses' }
          }
        }
      });
    }

    function renderCategoryRow(categoryId, data = {}) {
      const tr = document.createElement("tr");

      const nameCell = document.createElement("td");
      nameCell.className = "py-2 px-4 border font-medium bg-gray-50";
      nameCell.innerText = data.name || "Nova Categoria";
      tr.appendChild(nameCell);

      months.forEach(month => {
        const td = document.createElement("td");
        td.className = "border text-center py-2 px-4 hover:bg-yellow-50";
        td.contentEditable = true;

        db.ref(`cashflow/values/${categoryId}/${month}`).once("value", snapshot => {
          td.innerText = snapshot.val() || "";
        });

        td.addEventListener("blur", () => {
          const value = parseFloat(td.innerText.trim()) || 0;
          db.ref(`cashflow/values/${categoryId}/${month}`).set(value);
          loadAndRenderChart();
        });

        tr.appendChild(td);
      });

      tableBody.appendChild(tr);
    }

    function loadAndRenderChart() {
      db.ref("cashflow").once("value", snapshot => {
        const data = snapshot.val() || {};
        const values = data.values || {};
        const categories = data.categories || {};
        const receitas = {};
        const despesas = {};
        const saldos = {};

        months.forEach(month => {
          receitas[month] = 0;
          despesas[month] = 0;
        });

        Object.entries(values).forEach(([catId, meses]) => {
          const tipo = categories[catId]?.type || "Receita";
          months.forEach(month => {
            const val = parseFloat(meses[month]) || 0;
            if (tipo === "Receita") receitas[month] += val;
            else despesas[month] += val;
          });
        });

        months.forEach(month => {
          saldos[month] = receitas[month] - despesas[month];
        });

        updateSaldoRow(saldos);
        renderChart({ saldos });
      });
    }

    db.ref("cashflow/categories").once("value", snapshot => {
      const categories = snapshot.val() || {};
      Object.keys(categories).forEach(id => {
        renderCategoryRow(id, categories[id]);
      });
      loadAndRenderChart();
    });

    addBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
      newCategoryName.value = "";
      newCategoryType.value = "Receita";
    });

    cancelModal.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    saveCategory.addEventListener("click", () => {
      const name = newCategoryName.value.trim();
      const type = newCategoryType.value;
      if (!name) return;

      const newId = db.ref().child("cashflow/categories").push().key;
      const newData = { name, type };
      db.ref(`cashflow/categories/${newId}`).set(newData);
      renderCategoryRow(newId, newData);
      modal.classList.add("hidden");
      loadAndRenderChart();
    });
  </script>
</body>
</html>
